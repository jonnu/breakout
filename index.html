<!DOCTYPE html>
<html>
    <head>
        <title>Breakout</title>
        <meta charset="UTF-8" />
        <style>

        html, body {
            margin: 0;
            height: 100%;
        }

        #breakout {
            display: block;
            margin: 10px auto;
            border: solid 1px black;
        }

        </style>
    </head>
    <body>

        <canvas id="breakout" />

        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.2/require.js"></script>
        <script>

        require.config({
            baseUrl: "src"
        });

        define("breakout", ["breakout/container", "breakout/entity/ball", "breakout/entity/paddle", "breakout/collider", "breakout/collision/manager"], function (EntityManager, Ball, Paddle, Collider, CollisionManager) {

            var canvas = document.getElementById("breakout");
            var context = canvas.getContext("2d");

            canvas.width = document.body.clientWidth - 50;
            canvas.height = document.body.clientHeight - 50;

            var manager = new EntityManager();
            var ball = new Ball(canvas.width / 2, canvas.height - 30, 6, new Collider());
            var paddle = new Paddle(canvas.width / 2, canvas.height - 20, 100, 10, new Collider());

            // ball.collider.register(paddle.collider, function (paddle) {

            //     // invert.
            //     console.log("two colliders (ball and paddle) are colliding!", this, arguments);
            //     this.dy = -this.dy;

            // });

            ball.onCollisionWith(paddle, function () {
                console.log("Collision", this, arguments);
            });

            // ball.onCollisionWith(paddle, function (Paddle) {
            //     console.log("I collided with Paddle:", Paddle);
            // });

            manager.register("ball", ball);
            manager.register("paddle", paddle);

            console.log(manager);

            var Breakout = function () {};

            Breakout.prototype.render = function () {

                // flush
                context.clearRect(0, 0, canvas.width, canvas.height);

                // draw all entities
                for (var element in manager.elements) {
                    manager.elements[element].render && manager.elements[element].render.call(manager.elements[element], canvas, context);
                }

                // move all entities
                for (var element in manager.elements) {
                    manager.elements[element].move && manager.elements[element].move.call(manager.elements[element], canvas, context);
                }

                // check for collisions
                CollisionManager.check();
            };

            Breakout.prototype.init = function () {
                var game = new Breakout();
                setInterval(game.render, 10);
                return game;
            };

            return Breakout;
        });

        define("breakout/manager", function () {

            // entity manager.
            var Manager = function () {
                this.entities = {};
            };

            Manager.prototype.register = function (name, entity) {
                this.entities[name] = entity;
            };

            Manager.prototype.unregister = function (name, entity) {
                delete this.entities[name];
            };

            return Manager;
        });

        define("breakout/collider", ["breakout/collision/manager", "breakout/system/helper"], function (Manager, Helper) {

            var Collider = function (x, y, w, h, entity) {

                this.x = x;
                this.y = y;
                this.w = w;
                this.h = h;
                this.subscribers = {};
                this.guid = Helper.generateGuid();

                Manager.register(this);
            };

            Collider.prototype.register = function (collider, callback) {

                if (!this.subscribers.hasOwnProperty(collider.guid)) {
                    this.subscribers[collider.guid] = [];
                }

                this.subscribers[collider.guid].push(callback);
            };

            Collider.prototype.reposition = function (x, y, w, h) {

                this.x = x;
                this.y = y;

                if (w !== undefined) {
                    this.w = w;
                }


                if (h !== undefined) {
                    this.h = h;
                }
            }

            Collider.prototype.render = function (canvas, context) {

                // context.beginPath();
                // context.lineWidth = 2;
                // context.strokeStyle = "red";
                // context.rect(this.x, this.y, this.w, this.h);
                // context.stroke();
                // context.closePath();
            }

            return Collider;
        });





        require(["breakout"], function (Game) {

            document.getElementById("breakout").focus();
            var Breakout = new Game();
            Breakout.init();
            console.log("OK");
        });

        </script>

    </body>
</html>
